"use strict";(()=>{var L=async(t,r,d={})=>{let T=new Headers(d.headers||{});r&&T.set("Authorization",`Bearer ${r}`);let m=await fetch(t,{...d,headers:T}),a=await m.json().catch(()=>({}));if(!m.ok){let w=a.message||"Request failed",f=new Error(w);throw f.status=m.status,f}return a};var i=t=>document.getElementById(t),n=(t,r)=>{t&&(t.textContent=r)},x=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;"),M=(t,r)=>{t&&(t.classList.toggle("open",r),t.setAttribute("aria-hidden",r?"false":"true"),r?t.removeAttribute("inert"):t.setAttribute("inert",""),t.querySelectorAll("button, input, textarea, a").forEach(d=>{r?d.removeAttribute("tabindex"):d.setAttribute("tabindex","-1")}))};var P=t=>{try{return localStorage.getItem(t)}catch{return null}};(()=>{let t={token:P("lgxpkf.session"),user:null},r=document.body.dataset.noteId||"",d=document.body.dataset.authorId||"",T=document.body.dataset.accountNoteId||"",m=i("edit-note"),a=i("editor"),w=i("edit-form"),f=i("edit-value"),k=i("edit-status"),p=i("close-editor"),S=i("related-list"),A=i("version-card"),H=i("version-list"),N=i("copy-link"),B=i("copy-json"),E=i("copy-status"),s=i("follow-toggle"),c=i("follow-status"),v=i("link-form"),C=i("link-target"),I=i("link-kind"),y=i("link-status"),$=()=>!!(T&&T===r),h=()=>!!t.token&&!$(),F=e=>{m&&(m.disabled=!h()),s&&(s.disabled=!e),v&&v.querySelectorAll("input, textarea, button").forEach(o=>o.disabled=!e),w&&w.querySelectorAll("input, textarea, button").forEach(o=>o.disabled=!h())},J=e=>{let o=x(e.id||"");if(!o)return;let l=x(e.value||"Newer version"),u=x(e.created_at||""),b=`<span class="related-kind">Newer version</span><span class="related-text">${l}</span><span class="related-meta">${u}</span><span class="related-cite">Citation: ${o}</span>`;if(S&&!S.querySelector(`a[href="/${o}"]`)){let g=document.createElement("a");g.className="related-item related-item-version",g.href=`/${o}`,g.innerHTML=b,S.prepend(g)}if(H&&!H.querySelector(`a[href="/${o}"]`)){let g=document.createElement("a");g.className="related-item related-item-version",g.href=`/${o}`,g.innerHTML=b,H.prepend(g),A&&(A.hidden=!1)}},_=async()=>{if(!(!s||!c)){if(!t.token||!t.user){s.disabled=!0,c.textContent="Sign in to follow.";return}if(!d||t.user.user_id===d){s.disabled=!0,c.textContent="";return}s.disabled=!0,c.textContent="Checking follow...";try{let e=await L(`/follows?user=${t.user.user_id}&direction=following`,t.token),l=(Array.isArray(e.edges)?e.edges:[]).some(u=>{var b;return((b=u.user)==null?void 0:b.user_id)===d});s.dataset.following=l?"true":"false",s.textContent=l?"Unfollow":"Follow",c.textContent=l?"Following.":"Not following."}catch(e){n(c,e instanceof Error?e.message:"Follow check failed.")}finally{s.disabled=!1}}},q=e=>{t.token=e.token,t.user=e.user,F(!!t.token),_()};window.addEventListener("lgxpkf:session",e=>q(e.detail));let O=window.lgxpkfSession;O?q(O):(F(!!t.token),_()),N&&N.addEventListener("click",async()=>{if(!navigator.clipboard){n(E,"Clipboard unavailable.");return}try{await navigator.clipboard.writeText(window.location.href),n(E,"Link copied.")}catch{n(E,"Copy failed.")}}),B&&B.addEventListener("click",async()=>{if(!navigator.clipboard){n(E,"Clipboard unavailable.");return}if(!r){n(E,"Missing note id.");return}try{let e=await L(`/notes/${r}`,t.token,{headers:{}});await navigator.clipboard.writeText(JSON.stringify(e,null,2)),n(E,"JSON copied.")}catch(e){n(E,e instanceof Error?e.message:"Copy failed.")}}),s&&s.addEventListener("click",async()=>{if(!t.token){n(c,"Sign in at /signin.");return}if(!d){n(c,"Missing author id.");return}let e=s.dataset.following==="true";s.disabled=!0,n(c,e?"Unfollowing...":"Following...");try{await L("/follows",t.token,{method:e?"DELETE":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({followee_id:d})}),s.dataset.following=e?"false":"true",s.textContent=e?"Follow":"Unfollow",n(c,e?"Unfollowed.":"Following.")}catch(o){n(c,o instanceof Error?o.message:"Follow failed.")}finally{s.disabled=!1}}),v&&v.addEventListener("submit",async e=>{if(e.preventDefault(),!t.token){n(y,"Sign in at /signin.");return}if(!C||!I){n(y,"Link form unavailable.");return}let o=C.value.trim(),l=(I.value||"link").trim();if(!o){n(y,"Target note id required.");return}if(!l){n(y,"Association kind required.");return}n(y,"Linking...");try{await L("/associations",t.token,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:l,from_id:r,to_id:o})}),n(y,"Link created. Reload to view."),C.value=""}catch(u){n(y,u instanceof Error?u.message:"Link failed.")}}),w&&w.addEventListener("submit",async e=>{if(e.preventDefault(),!h()){n(k,"Editing disabled for this note.");return}let o=(f==null?void 0:f.value.trim())||"";if(!o){n(k,"Note text required.");return}n(k,"Publishing version...");try{let u=(await L("/notes",t.token,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:o})})).root||{};if(!u.id)throw new Error("Missing version id");await L("/associations",t.token,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"version",from_id:r,to_id:u.id})}),J(u),n(k,"Version published."),M(a,!1),document.body.classList.remove("modal-open")}catch(l){n(k,l instanceof Error?l.message:"Edit failed.")}}),m&&m.addEventListener("click",()=>{if(!h()){n(k,"Editing disabled for this note.");return}M(a,!0),document.body.classList.add("modal-open"),f==null||f.focus()}),p&&p.addEventListener("click",()=>{M(a,!1),document.body.classList.remove("modal-open")}),a&&a.addEventListener("click",e=>{e.target===a&&(p==null||p.click())}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(a!=null&&a.classList.contains("open"))&&p&&p.click()})})();})();
