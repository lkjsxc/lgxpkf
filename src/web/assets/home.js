"use strict";(()=>{var M=async(t,i,d={})=>{let f=new Headers(d.headers||{});i&&f.set("Authorization",`Bearer ${i}`);let c=await fetch(t,{...d,headers:f}),L=await c.json().catch(()=>({}));if(!c.ok){let y=L.message||"Request failed",T=new Error(y);throw T.status=c.status,T}return L};var o=t=>document.getElementById(t),m=(t,i)=>{t&&(t.textContent=i)},k=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;"),b=(t,i)=>{t&&(t.classList.toggle("open",i),t.setAttribute("aria-hidden",i?"false":"true"),i?t.removeAttribute("inert"):t.setAttribute("inert",""),t.querySelectorAll("button, input, textarea, a").forEach(d=>{i?d.removeAttribute("tabindex"):d.setAttribute("tabindex","-1")}))},I=t=>{if(!t||!(t instanceof HTMLElement))return!1;let i=t.tagName.toLowerCase();return i==="input"||i==="textarea"||t.isContentEditable};var K=t=>{try{return localStorage.getItem(t)}catch{return null}};(()=>{let t={token:K("lgxpkf.session"),user:null},i=o("guest-hero"),d=o("random-block"),f=o("random-list"),c=o("random-status"),L=o("timeline-block"),y=o("timeline-title"),T=o("timeline-list"),$=o("timeline-status"),a=o("composer"),h=o("post-link"),l=o("close-composer"),p=o("note-form"),s=o("note-value"),u=o("note-status"),E=o("submit"),S=e=>{document.body.dataset.signedIn=e?"true":"false",E&&(E.disabled=!e),s&&(s.disabled=!e),i&&(i.hidden=e),d&&(d.hidden=e),L&&(L.hidden=!e)},A=e=>{if(Array.isArray(e))return e;if(e&&typeof e=="object"){let n=e;if(Array.isArray(n.items))return n.items;if(Array.isArray(n.notes))return n.notes}return[]},C=e=>{var g;let n=document.createElement("a"),r=((g=e.author)==null?void 0:g.email)||"Unknown";return n.className="note",n.href=`/${k(e.id||"")}`,n.innerHTML=`<div class="note-meta"><span>${k(e.created_at||"")}</span><span>${k(r)}</span></div><div class="note-value">${k(e.value||"")}</div>`,n},j=async(e,n,r,g)=>{if(!(!n||!r)){r.textContent="Loading...";try{let x=await M(e,t.token),R=A(x);if(n.innerHTML="",!R.length){r.textContent=g;return}r.textContent="",R.forEach(_=>n.appendChild(C(_)))}catch(x){r.textContent=x instanceof Error?x.message:"Timeline failed."}}},v=()=>(y&&(y.textContent="Timeline"),j("/feed",T,$,"Timeline is empty.")),N=async()=>{if(!(!f||!c)){c.textContent="Loading random timeline...";try{let e=await fetch("/notes/random?limit=9");if(!e.ok)throw new Error("Random timeline failed");let n=await e.json().catch(()=>[]),r=A(n);if(f.innerHTML="",!r.length){c.textContent="No posts yet.";return}c.textContent="",r.forEach(g=>f.appendChild(C(g)))}catch{c.textContent="Random timeline unavailable."}}},w=new URLSearchParams(window.location.search).get("compose")==="1";w&&window.history.replaceState&&window.history.replaceState({},"",window.location.pathname);let H=()=>{if(!t.token){m(u,"Sign in at /signin.");return}m(u,""),b(a,!0),document.body.classList.add("modal-open"),s==null||s.focus()},P=()=>{!w||!t.token||(w=!1,H())},q=e=>{t.token=e.token,t.user=e.user,S(!!t.token),t.token?v():N(),P()},D=()=>{S(!!t.token),t.token?v():N(),P()};window.addEventListener("lgxpkf:session",e=>q(e.detail));let B=window.lgxpkfSession;B?q(B):D(),h&&h.addEventListener("click",e=>{e.preventDefault(),H()}),document.addEventListener("keydown",e=>{!h||h.hidden||e.key!=="n"||e.ctrlKey||e.metaKey||e.altKey||e.shiftKey||I(e.target)||a!=null&&a.classList.contains("open")||(e.preventDefault(),H())}),s&&s.addEventListener("keydown",e=>{e.key==="Enter"&&e.ctrlKey&&(e.preventDefault(),p!=null&&p.requestSubmit?p.requestSubmit():E==null||E.click())}),l&&l.addEventListener("click",()=>{b(a,!1),document.body.classList.remove("modal-open")}),a&&a.addEventListener("click",e=>{e.target===a&&(l==null||l.click())}),document.addEventListener("keydown",e=>{e.key==="Escape"&&(a!=null&&a.classList.contains("open"))&&l&&l.click()}),p&&p.addEventListener("submit",async e=>{if(e.preventDefault(),!t.token){m(u,"Sign in at /signin.");return}let n=(s==null?void 0:s.value.trim())||"";if(!n){m(u,"Note text required.");return}m(u,"Posting...");try{await M("/notes",t.token,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:n})}),s&&(s.value=""),m(u,"Posted."),l==null||l.click(),v()}catch(r){m(u,r instanceof Error?r.message:"Post failed.")}})})();})();
