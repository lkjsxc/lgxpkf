<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LGXPKF</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<style>:root{--bg:#f6f3ee;--ink:#1c1b19;--muted:#5e5b57;--panel:#fff8ef;--line:#ded7cd;--accent:#ff6b3d;--accent-2:#1b7f7a;--accent-3:#3b5bfd;--shadow:rgba(18,16,12,0.18);--mono:"JetBrains Mono",monospace;--sans:"Sora",sans-serif}*{box-sizing:border-box}body{margin:0;font-family:var(--sans);color:var(--ink);background:radial-gradient(circle at 10% 15%,rgba(255,107,61,0.18),transparent 55%),radial-gradient(circle at 88% 20%,rgba(59,91,253,0.14),transparent 52%),linear-gradient(135deg,#f6f3ee 0%,#f3eee7 50%,#efe7dd 100%);min-height:100vh}body.modal-open{overflow:hidden}a{text-decoration:none;color:inherit}.topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:18px 24px;background:rgba(246,243,238,0.9);backdrop-filter:blur(12px);border-bottom:1px solid var(--line)}.brand{font-size:1.1rem;letter-spacing:0.32em;font-weight:700}.account{display:flex;align-items:center;gap:12px}.account-info{display:flex;align-items:center;gap:10px;font-size:0.85rem}.account-info span{font-family:var(--mono);font-size:0.75rem;color:var(--muted)}button{border:none;border-radius:999px;padding:8px 16px;font-weight:600;background:var(--accent);color:#1c1b19;cursor:pointer}button.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}button:disabled{opacity:0.6;cursor:not-allowed}main{max-width:980px;margin:0 auto;padding:40px 24px 120px;display:flex;flex-direction:column;align-items:center;gap:28px}.hero{width:100%;display:flex;flex-direction:column;gap:12px;animation:rise 0.6s ease both}.hero h1{margin:0;font-size:clamp(2.2rem,6vw,4rem);letter-spacing:-0.03em}.hero p{margin:0;color:var(--muted);max-width:640px}.status{margin-top:12px;color:var(--accent-2);font-size:0.9rem}.panel{width:min(840px,100%);background:var(--panel);border:1px solid var(--line);border-radius:24px;padding:22px;box-shadow:0 24px 60px var(--shadow);animation:rise 0.6s ease both;animation-delay:0.1s}.panel-header{display:flex;align-items:center;justify-content:space-between;gap:12px}.panel-header h2{margin:0;font-size:1.4rem}.helper{font-size:0.8rem;color:var(--muted)}.timeline{display:flex;flex-direction:column;gap:14px;margin-top:18px}.note{border:1px solid var(--line);border-radius:18px;padding:16px;background:#fffaf4;display:flex;flex-direction:column;gap:10px}.note-meta{display:flex;flex-wrap:wrap;gap:10px;color:var(--muted);font-size:0.78rem}.note-value{font-family:var(--mono);font-size:0.9rem;white-space:pre-wrap}.note-actions{display:flex;flex-wrap:wrap;gap:8px}.note-actions a{padding:6px 12px;border-radius:999px;border:1px solid var(--line);font-size:0.78rem;color:var(--accent-3)}.note-actions a:hover{border-color:var(--accent-3)}.fab{position:fixed;left:20px;bottom:20px;z-index:20;box-shadow:0 18px 40px rgba(255,107,61,0.35)}.composer{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(20,16,12,0.6);opacity:0;pointer-events:none;transition:opacity 0.2s ease}.composer.open{opacity:1;pointer-events:auto}.composer-panel{width:min(720px,92vw);background:#fff8ef;border:1px solid var(--line);border-radius:28px;padding:24px;box-shadow:0 30px 80px rgba(18,16,12,0.35);animation:rise 0.4s ease both}.composer-head{display:flex;align-items:center;justify-content:space-between;gap:12px}.composer-head h2{margin:0;font-size:1.6rem}label{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.18em;color:var(--muted)}textarea{width:100%;margin-top:12px;min-height:220px;border-radius:18px;border:1px solid var(--line);padding:14px 16px;font-family:var(--mono);font-size:0.95rem;background:#fffdf9}.composer-actions{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:16px}@keyframes rise{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}@media (max-width:720px){.topbar{flex-direction:column;align-items:flex-start;gap:12px}.panel-header{flex-direction:column;align-items:flex-start}.fab{left:16px;bottom:16px}}</style>
</head>
<body data-client-id="{{CLIENT_ID}}">
<header class="topbar"><a class="brand" href="/">LGXPKF</a><div class="account"><div id="signin"></div><div class="account-info" id="account-info" hidden><span id="account-email"></span><button class="ghost" id="signout" type="button">Sign out</button></div></div></header>
<main>
<section class="hero"><h1>Signal grid for immutable notes.</h1><p>Post concise updates, review the central timeline, and jump into linked notes from a focused command desk.</p><div class="status" id="status">Sign in to unlock posting and timeline access.</div></section>
<section class="panel"><div class="panel-header"><div><h2>Timeline</h2><div class="helper">Centered feed of notes from you and people you follow.</div></div><button class="ghost" id="feed-refresh" type="button">Refresh</button></div><div id="feed-list" class="timeline"></div></section>
</main>
<button class="fab" id="open-composer" type="button">Post</button>
<div class="composer" id="composer" aria-hidden="true"><div class="composer-panel"><div class="composer-head"><h2>Compose note</h2><button class="ghost" id="close-composer" type="button">Close</button></div><form id="note-form"><label for="note-value">Note text</label><textarea id="note-value" maxlength="1024" placeholder="Markdown supported. 1024 bytes max."></textarea><div class="composer-actions"><div class="helper" id="note-status">Idle.</div><button id="submit" type="submit">Post now</button></div></form></div></div>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
(() => {
  const el = (id) => document.getElementById(id);
  const state = { token: localStorage.getItem("lgxpkf.session"), user: null };
  const clientId = document.body.dataset.clientId || "";
  const statusEl = el("status");
  const noteStatus = el("note-status");
  const feedList = el("feed-list");
  const submitBtn = el("submit");
  const signoutBtn = el("signout");
  const signinWrap = el("signin");
  const accountInfo = el("account-info");
  const composer = el("composer");
  const openBtn = el("open-composer");
  const closeBtn = el("close-composer");
  const setStatus = (text) => { statusEl.textContent = text; };
  const setNoteStatus = (text) => { noteStatus.textContent = text; };
  const setSignedIn = (signedIn) => {
    submitBtn.disabled = !signedIn;
    el("note-value").disabled = !signedIn;
    signoutBtn.disabled = !signedIn;
    accountInfo.hidden = !signedIn;
    signinWrap.hidden = signedIn;
  };
  const storeToken = (token) => {
    state.token = token;
    if (token) { localStorage.setItem("lgxpkf.session", token); }
    else { localStorage.removeItem("lgxpkf.session"); }
    setSignedIn(Boolean(token));
  };
  const api = async (path, options = {}) => {
    const headers = options.headers || {};
    if (state.token) { headers.Authorization = `Bearer ${state.token}`; }
    const response = await fetch(path, { ...options, headers });
    const data = await response.json().catch(() => ({}));
    if (!response.ok) { throw new Error(data.message || "Request failed"); }
    return data;
  };
  const esc = (value) => String(value).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#39;");
  const renderNote = (note) => {
    const card = document.createElement("article");
    card.className = "note";
    card.innerHTML = `<div class="note-meta"><span>${esc(note.created_at)}</span><span>${esc(note.author.email)}</span><span>${esc(note.id)}</span></div><div class="note-value">${esc(note.value)}</div><div class="note-actions"><a href="/${esc(note.id)}">Open note</a></div>`;
    return card;
  };
  const loadFeed = async () => {
    if (!state.token) { feedList.innerHTML = ""; return; }
    feedList.innerHTML = "<div class=\"helper\">Loading timeline...</div>";
    try {
      const feed = await api("/feed");
      feedList.innerHTML = "";
      if (!feed.length) { feedList.innerHTML = "<div class=\"helper\">Timeline is empty.</div>"; return; }
      feed.forEach((note) => feedList.appendChild(renderNote(note)));
    } catch (err) {
      feedList.innerHTML = `<div class="helper">${esc(err.message)}</div>`;
    }
  };
  const refreshSession = async () => {
    if (!state.token) { setSignedIn(false); return; }
    setStatus("Restoring session...");
    try {
      const data = await api("/auth/me", { headers: {} });
      state.user = data.user;
      el("account-email").textContent = data.user.email;
      setStatus(`Signed in as ${data.user.email}`);
      setSignedIn(true);
      loadFeed();
    } catch (_) {
      storeToken(null);
      setStatus("Session expired. Sign in again.");
    }
  };
  const handleCredential = async (payload) => {
    setStatus("Signing in...");
    try {
      const data = await api("/auth/google", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id_token: payload.credential }) });
      storeToken(data.token);
      state.user = data.user;
      el("account-email").textContent = data.user.email;
      setStatus(`Signed in as ${data.user.email}`);
      loadFeed();
    } catch (err) {
      storeToken(null);
      setStatus(err.message);
    }
  };
  const openComposer = () => {
    if (!state.token) { setNoteStatus("Sign in before posting."); return; }
    composer.classList.add("open");
    composer.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
    el("note-value").focus();
  };
  const closeComposer = () => {
    composer.classList.remove("open");
    composer.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  };
  el("note-form").addEventListener("submit", async (event) => {
    event.preventDefault();
    if (!state.token) { setNoteStatus("Sign in before posting."); return; }
    const value = el("note-value").value.trim();
    if (!value) { setNoteStatus("Note text required."); return; }
    setNoteStatus("Posting note...");
    try {
      await api("/notes", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ value }) });
      el("note-value").value = "";
      setNoteStatus("Note posted.");
      closeComposer();
      loadFeed();
    } catch (err) {
      setNoteStatus(err.message);
    }
  });
  composer.addEventListener("click", (event) => { if (event.target === composer) { closeComposer(); } });
  document.addEventListener("keydown", (event) => { if (event.key === "Escape" && composer.classList.contains("open")) { closeComposer(); } });
  el("feed-refresh").addEventListener("click", loadFeed);
  openBtn.addEventListener("click", openComposer);
  closeBtn.addEventListener("click", closeComposer);
  signoutBtn.addEventListener("click", () => { storeToken(null); state.user = null; el("account-email").textContent = ""; setStatus("Signed out."); feedList.innerHTML = ""; });
  window.addEventListener("load", () => {
    if (!clientId) { setSignedIn(false); setStatus("Missing GOOGLE_CLIENT_ID configuration."); return; }
    if (!window.google || !google.accounts || !google.accounts.id) { setSignedIn(false); setStatus("Google auth library failed to load."); return; }
    google.accounts.id.initialize({ client_id: clientId, callback: handleCredential });
    google.accounts.id.renderButton(signinWrap, { theme: "outline", size: "large", text: "signin_with" });
    refreshSession();
  });
})();
</script>
</body>
</html>
