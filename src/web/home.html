<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LGXPKF Timeline</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
<style>
:root{color-scheme:dark;--bg:#0b0e12;--ink:#f5f3ef;--muted:#a9a4a0;--panel:#151922;--edge:#272c36;--accent:#ff784f;--accent-2:#5dd2ff;--accent-3:#8bdc65;--shadow:rgba(0,0,0,0.5)}
*{box-sizing:border-box}
body{margin:0;font-family:"Space Grotesk",sans-serif;color:var(--ink);background:radial-gradient(circle at 12% 18%,rgba(255,120,79,0.22) 0%,transparent 45%),radial-gradient(circle at 82% 8%,rgba(93,210,255,0.2) 0%,transparent 42%),linear-gradient(160deg,#0b0e12 0%,#111725 55%,#0b0e12 100%);min-height:100vh}
main{max-width:1180px;margin:0 auto;padding:48px 24px 96px}
header{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-end;animation:rise 0.7s ease both}
h1{margin:0;font-size:clamp(2.8rem,5vw,4.4rem);letter-spacing:-0.02em}
header p{margin:0;font-size:1rem;color:var(--muted);max-width:520px}
.grid{display:grid;gap:20px;margin-top:28px}
@media (min-width:980px){.grid{grid-template-columns:1.1fr 0.9fr}}
.panel{background:var(--panel);border:1px solid var(--edge);border-radius:22px;padding:22px;box-shadow:0 22px 50px var(--shadow);animation:rise 0.6s ease both;animation-delay:var(--delay,0s)}
.panel h2{margin:0 0 10px;font-size:1.35rem}
.badge{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#0b0e12;padding:4px 12px;border-radius:999px;font-size:0.72rem;letter-spacing:0.1em;text-transform:uppercase}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between}
.status{font-size:0.95rem;color:var(--muted)}
button{border:none;border-radius:999px;padding:10px 18px;font-weight:600;font-size:0.9rem;cursor:pointer;background:var(--accent);color:#0b0e12}
button.secondary{background:transparent;color:var(--ink);border:1px solid var(--edge)}
button.ghost{background:transparent;color:var(--accent-2);border:1px solid transparent}
button:disabled{opacity:0.6;cursor:not-allowed}
input,textarea{width:100%;margin-top:10px;padding:12px 14px;border-radius:14px;border:1px solid var(--edge);font-family:"IBM Plex Mono",monospace;font-size:0.9rem;background:#0d111a;color:var(--ink)}
textarea{min-height:140px;resize:vertical}
label{font-size:0.78rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted)}
.note-card{padding:16px;border-radius:16px;border:1px solid var(--edge);background:#0f131e;margin-top:12px}
.note-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:0.78rem;color:var(--muted)}
.note-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.note-actions a{border:1px solid transparent;border-radius:999px;padding:6px 12px;font-size:0.78rem;color:var(--accent-2);text-decoration:none}
.note-actions a:hover{border-color:var(--edge)}
.note-value{font-family:"IBM Plex Mono",monospace;font-size:0.92rem;white-space:pre-wrap}
.list{display:flex;flex-direction:column;gap:12px}
.section{margin-top:28px}
.accent{color:var(--accent)}
.small{font-size:0.82rem;color:var(--muted)}
@keyframes rise{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body data-client-id="{{CLIENT_ID}}">
<main>
<header>
<div>
  <div class="badge">Timeline</div>
  <h1>LGXPKF Signal Wall</h1>
</div>
<p>Post immutable notes, stitch them together, and browse your timeline in a bold, single-page console.</p>
</header>
<section class="panel section" style="--delay:0.1s;">
  <div class="row"><div id="signin"></div><button class="secondary" id="signout" type="button">Sign out</button></div>
  <div class="status" id="status">Authenticate to unlock posting and timeline views.</div>
</section>
<section class="grid section">
  <div class="panel" style="--delay:0.2s;">
    <h2>Compose</h2>
    <form id="note-form">
      <label for="note-value">New note</label>
      <textarea id="note-value" maxlength="1024" placeholder="Write up to 1024 bytes..."></textarea>
      <div class="row" style="margin-top:12px;"><div class="small">Immutable, capped at 1024 bytes.</div><button id="submit" type="submit">Post note</button></div>
    </form>
    <div class="status" id="note-status"></div>
  </div>
  <div class="panel" style="--delay:0.3s;">
    <h2>Associate notes</h2>
    <form id="assoc-form">
      <label for="assoc-kind">Kind</label>
      <input id="assoc-kind" placeholder="next | prev | new | old | parent | child">
      <label for="assoc-from">From note id</label>
      <input id="assoc-from" placeholder="base32 id">
      <label for="assoc-to">To note id</label>
      <input id="assoc-to" placeholder="base32 id">
      <div class="row" style="margin-top:12px;"><div class="small">Use timeline actions to fill ids.</div><button type="submit">Link notes</button></div>
    </form>
    <div class="status" id="assoc-status"></div>
  </div>
</section>
<section class="panel section" style="--delay:0.4s;">
  <div class="row">
    <div><h2>Timeline</h2><div class="small">Notes from you and people you follow.</div></div>
    <button class="secondary" id="feed-refresh" type="button">Refresh</button>
  </div>
  <div id="feed-list" class="list"></div>
</section>
<section class="panel section" style="--delay:0.5s;">
  <h2>Related notes</h2>
  <form id="related-form">
    <label for="related-id">Note id</label>
    <input id="related-id" placeholder="base32 id">
    <div class="row" style="margin-top:12px;"><div class="small">Loads associations and linked notes.</div><button type="submit">Load related</button></div>
  </form>
  <div id="related-panel" class="section"></div>
</section>
</main>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
(() => {
  const el = (id) => document.getElementById(id);
  const state = { token: localStorage.getItem("lgxpkf.session"), user: null, feed: [] };
  const clientId = document.body.dataset.clientId || "";
  const statusEl = el("status");
  const noteStatus = el("note-status");
  const assocStatus = el("assoc-status");
  const feedList = el("feed-list");
  const relatedPanel = el("related-panel");
  const submitBtn = el("submit");
  const signoutBtn = el("signout");
  const setStatus = (text) => { statusEl.textContent = text; };
  const setNoteStatus = (text) => { noteStatus.textContent = text; };
  const setAssocStatus = (text) => { assocStatus.textContent = text; };
  const setSignedIn = (signedIn) => { submitBtn.disabled = !signedIn; el("note-value").disabled = !signedIn; signoutBtn.disabled = !signedIn; };
  const storeToken = (token) => { state.token = token; if (token) { localStorage.setItem("lgxpkf.session", token); } else { localStorage.removeItem("lgxpkf.session"); } setSignedIn(Boolean(token)); };
  const api = async (path, options = {}) => { const headers = options.headers || {}; if (state.token) { headers.Authorization = `Bearer ${state.token}`; } const response = await fetch(path, { ...options, headers }); const data = await response.json().catch(() => ({})); if (!response.ok) { throw new Error(data.message || "Request failed"); } return data; };
  const esc = (value) => String(value).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#39;");
  const renderNote = (note) => { const card = document.createElement("div"); card.className = "note-card"; card.innerHTML = `<div class=\"note-meta\"><span>${esc(note.created_at)}</span><span class=\"accent\">${esc(note.author.email)}</span><span>${esc(note.id)}</span></div><div class=\"note-value\">${esc(note.value)}</div><div class=\"note-actions\"><button class=\"ghost\" data-action=\"from\" data-id=\"${esc(note.id)}\">Use as from</button><button class=\"ghost\" data-action=\"to\" data-id=\"${esc(note.id)}\">Use as to</button><button class=\"ghost\" data-action=\"related\" data-id=\"${esc(note.id)}\">Related</button><a href=\"/${esc(note.id)}\">Open note</a></div>`; return card; };
  const loadFeed = async () => { if (!state.token) { feedList.innerHTML = ""; return; } feedList.innerHTML = "<div class=\"small\">Loading timeline...</div>"; try { state.feed = await api("/feed"); feedList.innerHTML = ""; if (!state.feed.length) { feedList.innerHTML = "<div class=\"small\">Timeline is empty.</div>"; return; } state.feed.forEach((note) => feedList.appendChild(renderNote(note))); } catch (err) { feedList.innerHTML = `<div class=\"small\">${err.message}</div>`; } };
  const loadRelated = async (id) => { if (!id) { relatedPanel.innerHTML = ""; return; } relatedPanel.innerHTML = "<div class=\"small\">Loading related notes...</div>"; try { const data = await api(`/notes/${id}/related`, { headers: {} }); relatedPanel.innerHTML = ""; const center = renderNote(data.center); center.querySelectorAll("button").forEach((btn) => btn.remove()); relatedPanel.appendChild(center); if (!data.related.length) { relatedPanel.insertAdjacentHTML("beforeend", "<div class=\"small\">No related notes.</div>"); return; } data.related.forEach((entry) => { const wrap = document.createElement("div"); wrap.className = "note-card"; wrap.innerHTML = `<div class=\"note-meta\"><span>${esc(entry.association.kind)}</span><span>${esc(entry.association.created_at)}</span><span>${esc(entry.note.id)}</span></div><div class=\"note-value\">${esc(entry.note.value)}</div>`; relatedPanel.appendChild(wrap); }); } catch (err) { relatedPanel.innerHTML = `<div class=\"small\">${err.message}</div>`; } };
  const refreshSession = async () => { if (!state.token) { setSignedIn(false); return; } setStatus("Restoring session..."); try { const data = await api("/auth/me", { headers: {} }); state.user = data.user; setStatus(`Signed in as ${data.user.email}`); setSignedIn(true); loadFeed(); } catch (_) { storeToken(null); setStatus("Session expired. Sign in again."); } };
  const handleCredential = async (payload) => { setStatus("Signing in..."); try { const data = await api("/auth/google", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id_token: payload.credential }) }); storeToken(data.token); state.user = data.user; setStatus(`Signed in as ${data.user.email}`); loadFeed(); } catch (err) { storeToken(null); setStatus(err.message); } };
  el("note-form").addEventListener("submit", async (event) => { event.preventDefault(); if (!state.token) { setNoteStatus("Sign in before posting."); return; } const value = el("note-value").value.trim(); if (!value) { setNoteStatus("Note text required."); return; } setNoteStatus("Posting note..."); try { await api("/notes", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ value }) }); el("note-value").value = ""; setNoteStatus("Note posted."); loadFeed(); } catch (err) { setNoteStatus(err.message); } });
  el("assoc-form").addEventListener("submit", async (event) => { event.preventDefault(); if (!state.token) { setAssocStatus("Sign in before linking notes."); return; } const kind = el("assoc-kind").value.trim() || "other"; const fromId = el("assoc-from").value.trim(); const toId = el("assoc-to").value.trim(); if (!fromId || !toId) { setAssocStatus("Both note ids are required."); return; } setAssocStatus("Creating association..."); try { await api("/associations", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ kind, from_id: fromId, to_id: toId }) }); setAssocStatus("Association created."); el("assoc-kind").value = ""; } catch (err) { setAssocStatus(err.message); } });
  el("related-form").addEventListener("submit", async (event) => { event.preventDefault(); loadRelated(el("related-id").value.trim()); });
  feedList.addEventListener("click", (event) => { const btn = event.target.closest("button"); if (!btn) return; const id = btn.dataset.id; if (btn.dataset.action === "from") { el("assoc-from").value = id; } if (btn.dataset.action === "to") { el("assoc-to").value = id; } if (btn.dataset.action === "related") { el("related-id").value = id; loadRelated(id); } });
  el("feed-refresh").addEventListener("click", loadFeed);
  signoutBtn.addEventListener("click", () => { storeToken(null); state.user = null; setStatus("Signed out."); feedList.innerHTML = ""; relatedPanel.innerHTML = ""; });
  window.addEventListener("load", () => { if (!clientId) { setSignedIn(false); setStatus("Missing GOOGLE_CLIENT_ID configuration."); return; } if (!window.google || !google.accounts || !google.accounts.id) { setSignedIn(false); setStatus("Google auth library failed to load."); return; } google.accounts.id.initialize({ client_id: clientId, callback: handleCredential }); google.accounts.id.renderButton(el("signin"), { theme: "outline", size: "large", text: "signin_with" }); refreshSession(); });
})();
</script>
</body>
</html>
